<!DOCTYPE html>
<html>
    <head>
        <title>Chat-Log</title>

        <meta http-equiv="Cache-control" content="no-cache">
        <meta http-equiv="Expires" content="-1">

        <link rel="stylesheet" href="css/basicStyle.css" type="text/css" />
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,600italic,700italic,400,600,700' rel='stylesheet' type='text/css'>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="js/spin.min.js"></script>
        <script src="js/jquery.cookie.js"></script>
        <script src="js/nicescroll.min.js"></script>
        <script src="js/jquery.elastic.js"></script>
        <script src="js/handlebars-v1.3.0.js"></script>
        <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>

        <script src="templates/templates.js"></script>

        <script>
            var CURRENT_CHAT = null;
            var MY_ID = null;
            var CHATS = {};
            var socket;

            $(document).ready(function(){
                $(".sidebar-scroller").niceScroll();
                $(".chat-scroller").niceScroll();

                $("#chat-input").elastic();

                $("#chat-input").on("input keyup", function(){
                    $(".chat-scroller").height($(".actual-chat").height() - $("#chat-input").height() - 32);
                });

                $("#chat-input").keydown(function(e){
                    if(e.keyCode == 13 && !e.shiftKey){
                        submit();

                        e.stopPropagation();
                        e.preventDefault();
                        return false;
                    }
                });

                $("#chat-submit").click(function(){
                    submit();
                });

                socket = io();

                socket.on("message", function(chatId, fromId, fromName, message){
                    CHATS[chatId].listing.find(".most-recent").text(fromName + ": " + message);
                    if(CURRENT_CHAT == chatId){
                        appendMessage({message: message, sender: fromId, you: MY_ID == fromId});
                        socket.emit("up to date", chatId);
                    } else {
                        CHATS[chatId].unread++;
                        CHATS[chatId].listing.find(".unread-count").css({visibility: "visible"}).text(CHATS[chatId].unread);
                    }
                });

                socket.on("error", function(descr){
                    toast(descr.description);
                });

                socket.on("commrequest", function(source, name){
                    permissionToast(source + " would like to add the " + name + " comm to this chat.");
                });

                socket.on("login success", function(dat){
                    MY_ID = dat.id;
                    init();
                });

                socket.emit("login", $.cookie("email"), $.cookie("authToken"));
            });



            var submit = function(){
                var data = $("#chat-input").val();
                $("#chat-input").val("");
                socket.emit("message", CURRENT_CHAT, "plaintext", data);
                return false;
            }

            var openChat = function(chatId){
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/chat/history", true);

                xhr.onload = function(){
                    var data = JSON.parse(this.responseText);

                    $(".chat-scroller").empty();

                    for(var i = 0; i < data.length; i++){
                        data[i].you = data[i].sender == MY_ID;
                        appendMessage(data[i]);
                    }

                    CHATS[chatId].listing.find(".unread-count").css({visibility: "hidden"});
                    CHATS[chatId].unread = 0;
                }

                xhr.setRequestHeader("Content-Type", "application/json");

                xhr.send(JSON.stringify({
                    email: $.cookie("email"),
                    authToken: $.cookie("authToken"),
                    chatId: chatId
                }));

                CURRENT_CHAT = chatId;
            }

            var appendMessage = function(msg){
                if(!($(".chat-scroller").children().last().attr("id") == msg.sender)){
                    $(".chat-scroller").append(Handlebars.templates["chat-group"]({
                        sender: msg.sender,
                        you: msg.sender == MY_ID
                    }));
                }
                $(".chat-scroller").children().last().append(Handlebars.templates["chat-message"]({
                    message: msg.message
                }));
                $(".chat-scroller").scrollTop(2e9);
            }

            var toast = function(msg){
                $(".toast-msg").text(msg).css({opacity: 1});
                setTimeout(function(){ $(".toast-msg").css({opacity: 0}); }, 5000);
            }

            var permissionToast = function(msg){
                $(".toast-perm .prompt").text(msg).css({opacity: 1});
                setTimeout(function(){ $(".toast-perm").css({opacity: 0}); }, 5000);
            }

            var init = function(){
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/chats", true);

                xhr.onload = function(){
                    console.log(this.responseText);
                    chats = JSON.parse(this.responseText);

                    for(var i = 0; i < chats.length; i++){
                        CHATS[chats[i]._id] = {
                            users: chats[i].users,
                            unread: chats[i].messageCount - chats[i].lastRead[MY_ID],
                            listing: $(Handlebars.templates["chat-listing"]({
                                id: chats[i]._id,
                                title: chats[i]._id.substring(0, 8) + "...",
                                members: chats[i].users.join(", "),
                                mostRecent: chats[i].messages[0]
                            }))
                        }
                        $(".sidebar-scroller").append(CHATS[chats[i]._id].listing);
                        if(CHATS[chats[i]._id].unread > 0){
                            CHATS[chats[i]._id].listing.find(".unread-count").css({visibility: "visible"}).text(CHATS[chats[i]._id].unread);
                        }
                    }

                    openChat(chats[0]._id);

                    $(".chat-listing").click(function(){
                        openChat($(this).attr("data-chat-id"));
                    });
                };

                xhr.setRequestHeader("Content-Type", "application/json");

                xhr.send(JSON.stringify({
                    email: $.cookie("email"),
                    authToken: $.cookie("authToken")
                }));
            }
        </script>
    </head>
    <body>
        <div class="app">
            <div class="top-bar">
                <div class="title-area">
                    <img src="images/icon.png" class="app-icon" />
                    <h1>&Agrave; la Mod</h1>
                </div>
                <h2></h2>
            </div>
            <div class="messages">
                <div class="sidebar-scroller">
                    <div class="search-chats">
                        <input id="search" type="text" placeholder="Search..." />
                    </div>
                </div>
            </div>
            <div class="right-bar">
                <div class="active-chat">
                    <div class="actual-chat">
                        <div class="chat-scroller"></div>
                        <textarea id="chat-input" rows="5" cols="40" name="send" placeholder="Message..."></textarea>
                        <button id="chat-submit">Submit</button>
                    </div>
                    <div class="modules-bar">
                        <img src="http://4vector.com/thumb_data/afd-56603.jpg" height=32 width=32>
                        <img src="http://www.psdgraphics.com/file/white-board-template.jpg" height=32 width=32>
                    </div>
                    <div class="modules"></div>
                </div>
            </div>
            <div class="toast toast-msg"></div>
            <div class="toast toast-perm">
                <div class="prompt"></div>
                <a href="#" id="yes">Yes</a>
                <a href="#" id="no">No</a>
            </div>
        </div>
    </body>
</html>