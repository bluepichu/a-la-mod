<html>
	<head>
		<script src="/mods/utils/ui-base"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<link rel="stylesheet" href="/mods/ui/creamery/whiteboard/styles.css" />

		<script>
			$(document).ready(function(){
				var drawing = false;
				var lastX = 0;
				var lastY = 0;
				var brushSize = 5;

				var context = $("#canvas").get(0).getContext("2d");

				$("#canvas").mousedown(function(e){
					var lastX = e.pageX - $(this).offset().left;
					var lastY = e.pageY - $(this).offset().top;
					drawing = true;
				});

				$("#canvas").mouseup(function(e){
					drawing = false;
				});

				$("#canvas").mouseleave(function(e){
					drawing = false;
				});

				$("#canvas").mousemove(function(e){
					var nextX = e.pageX - $(this).offset().left;
					var nextY = e.pageY - $(this).offset().top;
					if(drawing){
						sendMessage({
							message: {
								x1: lastX,
								y1: lastY,
								x2: nextX,
								y2: nextY,
								r: brushSize
							},
							name: "creamery/whiteboard"
						});
					}
					lastX = nextX;
					lastY = nextY;
				});

				$("body").keypress(function(e){
					if(e.keyCode == 91){
						brushSize--;
					} else {
						brushSize++;
					}
					brushSize = Math.min(Math.max(brushSize, 1), 100);
				});

				registerMethod("postUI", function(data) {
					console.log(data);
					draw(context, data.x1, data.y1, data.x2, data.y2, data.r);
				})

				var draw = function(canvas, x1, y1, x2, y2, r){
					canvas.strokeStyle = "#0000ff";
					canvas.lineJoin = "round";
					canvas.lineWidth = r;
					canvas.beginPath();
					canvas.moveTo(scale(x1), scale(y1));
					canvas.lineTo(scale(x2), scale(y2));
					canvas.closePath();
					canvas.stroke();
				}

				var scale = function(x){
					return x * 800 / $("#canvas").width();
				}
				});
		</script>
	</head>
	<body>
		<div class="container">
			<canvas id="canvas" width="800" height="480"></canvas>
		</div>
	</body>
</html>
